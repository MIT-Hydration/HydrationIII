syntax = "proto3";
package mission_control;

enum SystemMode {
    UNKNOWN = 0;
    READY = 1;
    CALIBRATING = 2;
    MANUAL = 3;

    RIG_STANDBY = 101;
    RIG_DRILL_POSITIONING_XY = 102; // user has requested to move the rig to drill at position XY
    RIG_WATER_POSITIONING_XY = 103; // user has requested to move the rig to extract water at position XY
    
    DRILL_STANDBY = 201; // ready to receive user input, could be stopped due to emergency stop

    // moves to the top and makes sure that the limit switch is hit, and other calibration can also be done
    DRILL_CALIBRATING = 202; 
    
    // user has asked to descend without turning on the drill with a given target position
    DRILL_DESCENDING_OFF = 203;

    // user has asked to descend with the drill on, drill is being controlled through a control loop
    DRILL_DESCENDING_DRILLING = 204;
    
    // drill is withdrawing with the drill motor off to a target position
    DRILL_ASCENDING_OFF = 205;

    // drill is withdrawing with the drill motor on to a target position
    DRILL_ASCENDING_ON = 206;

    // drill calibration had an error
    DRILL_CALIBRATION_ERROR = 250;
    
    HEATING = 12;
}

enum CommandReport {
    EXECUTED = 0;
    INVALID_STATE = 1;
    EXECUTION_ERROR = 2;
}

message HeartBeatRequest {
    uint64 request_timestamp = 1;
}

message HeartBeatReply {
    uint64 timestamp = 1;
    uint64 request_timestamp = 2;
    bool drill_subsystem_online = 3;
    bool heater_sussystem_online = 4;
    bool fan_on  = 5;
    float cpu_temperature_degC = 6;
    SystemMode mode = 7;
}

message RigStatusRequest {
    uint64 request_timestamp_ms = 1;
}

message RigStatusResponse {
    uint64 timestamp_ms = 1;
    uint64 request_timestamp_ms = 2;
    
    float x_position_m = 10;        // position with the left limit switch being position zero, and rightward is positive
    float x_velocity_m_s = 11;      // velocity in meter per second
    float y_position_m = 12;        // position with the front limit switch being position zero, and behind is negative
    float y_velocity_m_s = 13;      // velocity in meter per second
    
    bool last_calibration_success = 20; // whether the last calibration command was successful
}

message DrillAssemblyStatusRequest {
    uint64 request_timestamp_ms = 1;
}

message DrillAssemblyStatusResponse {
    uint64 timestamp_ms = 1;
    uint64 request_timestamp_ms = 2;
    float drill_setting = 3;     // 0.0 == off, 0.5 == half waveform from the triac, 1.0 // fully on
    float tachometer_RPM = 4;    // current reading from the tachometer
    float drill_e_power_W   = 5;   // real electric power readimng from drill power meter
    float drill_e_current_A = 6;   // total electric current (real + imaginary)
    float z_position_m = 7;        // position with the top limit switch being position zero, and downward is negative
    float z_velocity_m_s = 8;      // velocity in meter per second
    float cpu_temperature_degC = 9;     // Raspberry Pi or any other control computer temperature
    bool last_calibration_success = 20; // whether the last calibration command was successful
    bool calibration_error_state = 21;  // are we in calibration error state? if yes, the valid commands are limited
}

message RigMoveCommandRequest {
    uint64 request_timestamp = 1;
    float x = 2;
    float y = 3;
}

message DrillModeRequest {
    uint64 request_timestamp = 1;
    bool drill_mode = 2;
}

message DrillCalibrationRequest {
    uint64 request_timestamp = 1;
}

message DrillDescendingOffRequest {
    uint64 request_timestamp = 1;
    float target_z_m = 2; // example -1.3 [m] (negative as we are using top as zero, negative downward direction)
}

message DrillDescendingDrillingRequest {
    uint64 request_timestamp = 1;
    float target_z_m = 2; // example -1.3 [m] (negative as we are using top as zero, negative downward direction)
}

message CommandResponse {
    uint64 timestamp = 1;
    uint64 request_timestamp = 2;
    CommandReport status = 3;
}

message EmergencyStopRequest {
    uint64 request_timestamp = 1;
}

service MissionControl {
    rpc HeartBeat (HeartBeatRequest) returns (HeartBeatReply);
    
    rpc RigMove (RigMoveCommandRequest) returns (CommandResponse);
    rpc DrillMode (DrillModeRequest) returns (CommandResponse);
    rpc DrillCalibration (DrillCalibrationRequest) returns (CommandResponse);
    rpc DrillDescendingOff (DrillDescendingOffRequest) returns (CommandResponse);
    rpc DrillDescendingDrilling (DrillDescendingDrillingRequest) returns (CommandResponse);
    
    rpc EmergencyStop (EmergencyStopRequest) returns (CommandResponse);

    rpc DrillAssemblyStatus (DrillAssemblyStatusRequest) returns (DrillAssemblyStatusResponse);
}

service DrillControl {
    rpc HeartBeat (HeartBeatRequest) returns (HeartBeatReply);
    rpc DrillAssemblyStatus (DrillAssemblyStatusRequest) returns (DrillAssemblyStatusResponse);
    rpc DrillMode (DrillModeRequest) returns (CommandResponse);
    rpc EmergencyStop (EmergencyStopRequest) returns (CommandResponse);
    rpc DrillCalibration (DrillCalibrationRequest) returns (CommandResponse);
}